---

- name: install required apt packages
  become: yes
  apt:
    name: "{{ packages }}"
    update_cache: yes
  vars:
    packages:
      - vim
      - git
      - nmap
      - curl
      - tmux
      - python3-pip
      - python-pip
      - virtualenv
      - libatlas-base-dev
      - libopenjp2-7
      - libwebp6
      - libtiff5
      - libjbig0
      - liblcms2-2
      - libwebpmux3
      - libopenjp2-7
      - libzstd1
      - libwebpdemux2
      - gvfs
      - gvfs-fuse
      - gvfs-bin
      - gvfs-backends
      - ifuse
  register: installed

- name: install workoutizer git repo
  git:
    repo: 'https://gitlab.com/fgebhart/workoutizer.git'
    dest: "{{ path_to_workoutizer }}"
    clone: yes
    force: yes

- name: copy udev rule for automated mounting
  become: yes
  copy:
    src: config/5-mount.rules
    dest: /etc/udev/rules.d/5-mount.rules

- name: create venv
  pip:
    virtualenv: "/home/pi/wkz"
    requirements: "{{ path_to_workoutizer }}requirements.txt"
    virtualenv_python: python3.7

- name: insert dropbox token into remote config file
  lineinfile:
    path: "{{ path_to_workoutizer }}/setup/config.ini"
    regex: "^dropbox_token="
    line: "dropbox_token    = {{ dropbox_token }}"

- name: reboot to apply changes
  become: yes
  reboot:
    reboot_timeout: 80
  when: installed.changed

- name: download database from dropbox
  shell: "/home/pi/wkz/bin/python {{ path_to_workoutizer }}dbx/download_db.py"
  args:
    creates: "{{ path_to_workoutizer }}workoutizer/db.sqlite3"

- name: backup database with cron schedule
  become: yes
  lineinfile:
    path: "/etc/crontab"
    line: "0 6	* * *	pi	/home/pi/wkz/bin/python {{ path_to_workoutizer }}dbx/upload_db.py"

- name: create traces folder
  file:
    path: /home/pi/traces/garmin
    state: directory
    recurse: yes
    owner: pi

- name: copy workoutizer systemd service file to pi
  become: yes
  copy:
    src: config/workoutizer.service
    dest: /etc/systemd/system/workoutizer.service

- name: enable and start workoutizer systemd service
  become: yes
  systemd:
    enabled: yes
    name: workoutizer.service
    state: restarted
...