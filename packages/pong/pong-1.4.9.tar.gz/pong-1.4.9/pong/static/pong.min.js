$(document).ready(function(){$(window).on("beforeunload",function(){$(window).scrollTop(0)}),$("#loading").fadeIn();var l,m,_,s,w,x,k,A,j,K,S,t=window.innerWidth,P=(window.innerHeight,.9*t),C=160,z="black",D=!1,o=!1,M=!1,L=d3.stack(),O=d3.area().x(function(t,e){return q(t.data.index)}).y0(function(t){return V(t[0])}).y1(function(t){return V(t[1])}).curve(d3.curveStepAfter),B=["#E04B4B","#6094C3","#63BC6A","#A76BB2","#F0934E","#FEFB54","#B37855","#EF91CA","#A4A4A4"],d=["#f0a3ff","#0075dc","#993f00","#4c005c","#191919","#005c31","#2bce48","#ffcc99","#808080","#94ffb5","#8f7c00","#9dcc00","#c20088","#003380","#ffa405","#ffa8bb","#426600","#ff0010","#5ef1f2","#00998f","#e0ff66","#740aff","#990000","#ffff80","#ffff00","#ff5005"],G=0,q=d3.scale.linear(),V=d3.scale.linear(),I=d3.behavior.zoom().on("zoom",function(){{var t;q.domain()[0]<0?(t=I.translate()[0]-q(0)+q.range()[0],I.translate([t,0])):q.domain()[1]>j&&(t=I.translate()[0]-q(j)+q.range()[1],I.translate([t,0]))}d3.selectAll("g.x.axis").call(S);var e=d3.event.translate[0],a=d3.event.scale;e=Math.min(0,Math.max(w*(1-a),e)),d3.selectAll("path.area").attr("transform","translate("+e+",0)scale("+a+", 1)"),d3.selectAll(".popLabels").attr("transform",function(t){return"translate("+(q(t)+5)+",10)rotate(45)"}).style("fill",function(t){return q(t)+5<0||q(t)+5>w?"none":"black"})}),e=(new Array,$(window).width());$(window).resize(function(){$(this).width()!=e&&(e=$(this).width(),this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){$("#resize-warning-nav").show()},500))}),$("#resize-warning-exit").click(function(){$("#resize-warning-nav").hide()});var a="ws://"+location.host+"/pongsocket",r=new WebSocket(a),p=0,c=0;r.onmessage=function(t){var e,a,n,i=JSON.parse(t.data);if("pong-data"==i.type){for(var o in(K=i.pong).qmatrices)modes=Object.keys(K.qmatrices[o].modes).length,1==modes?c+=1:c+=modes+1;for($("#loading").fadeIn(),G+=K.qmatrices.length,s=K.hasOwnProperty("popNames")&&K.hasOwnProperty("popSizes")?(_=K.popNames,K.popSizes):(_={},{}),0<K.colors.length?B=K.colors:9<K.K_max&&(B=d),l=new Array,o=0;o<K.qmatrices.length;o++){var r=K.qmatrices[o].major_mode_runid;plot=d3.select("#visualization").append("svg").attr("width",P).attr("height",175).attr("class","majorSVG "+K.qmatrices[o].K).attr("id","plot"+r),l.push(plot),u(r,"no",null,null)}}else{"q-matrix"==i.type&&(p+=1,d3.select("#progress-bar").transition().attr("width",280*p/c),e="yes"==i.minor,a=i.minorID,n=i.is_first,h(e?d3.select("#plot"+i.name+"_minor"):d3.select("#plot"+i.name),i.K,i.matrix2d,e,a,n,i.name))}};var u=function(t,e,a,n){r.send(JSON.stringify({type:"get-qmatrix",name:t,minor:e,minorID:a,is_first:n}))},h=function(t,n,e,o,r,a,l){var s=K.qmatrices[n-K.K_min].color_perm;w=.84*P,k=.08*P,A=0;var d=K.qmatrices[n-K.K_min],p=d.major_mode_runid,c=Object.keys(d.modes),m=c.indexOf(p);-1<m&&c.splice(m,1);var u=F(d,c);0==c.length||o||(G+=c.length+1,E(n,u)),o?T(t,d,r,a):(H(t,n,d),W(t,n,p));t.append("rect").attr("class","background").attr("x",k-2.5).attr("y",12.5).attr("height",133).attr("width",w+5).attr("fill",z);var h=t.append("g").attr("transform","translate("+k+", 15)").attr("class","chart").attr("clip-path","url(#clip)");h.append("clipPath").attr("id","clip").append("rect").attr("width",w).attr("height",178),j=1+e.slice(-1)[0].members.slice(-1)[0].index,q.range([0,w]).domain([0,j]),V.range([128,0]).domain([0,1]),tickVals=[],e.forEach(function(t){tickVals.push(t.members[0].index)});var g=Object.keys(e[0].members[0]).filter(function(t){return"index"!=t}).sort(at);L.keys(g),h.selectAll(".pops").data(e).enter().append("g").attr("class",function(t){return"pops population"+t.population_index}).selectAll(".layer").data(function(t){for(var e=L(t.members),a=0;a<e.length;a++)e[a].population_index=t.population_index,e[a].K=n,e[a].indiv_avg=K.indiv_avg[l][t.population_index];return e}).enter().append("g").attr("class","layer").append("path").attr("class",function(t,e){var a="area ";return o&&(a+=r+"_minorCluster"+s[e]+" "),a+="K"+t.K+" population"+t.population_index+" cluster"+s[e]}).style("fill",function(t,e){return B[s[e]]}).attr("d",function(t,e){var a=[0,0];return a.data={index:t[t.length-1].data.index+1},t[t.length]=a,O(t)}).on("click",function(a){M||(d3.selectAll("path.area").style("fill",function(t){var e=K.qmatrices[t.K-K.K_min].color_perm;return!D&&e[parseInt(t.key.slice(7))-1]!=s[parseInt(a.key.slice(7))-1]?"white":B[e[parseInt(t.key.slice(7))-1]]}),D?d3.selectAll(".check-input").attr("disabled",null):d3.selectAll(".check-input").attr("disabled","disabled"),D=!D)});var f,v,y,b=d3.selectAll("path.area");b.call(I).on("dblclick.zoom",null),0<Object.keys(_).length&&b.call(J).on("mouseover",J.show).on("mouseout",J.hide),d3.selectAll("#major_repstring").call(Y).on("mouseover",Y.show).on("mouseout",Y.hide),o&&d3.selectAll("#minor_repstring").call(Y).on("mouseover",Y.show).on("mouseout",Y.hide),S=d3.svg.axis().scale(q).orient("bottom").tickValues(tickVals).tickFormat("").tickSize(-128),h.append("g").attr("class","x axis").attr("transform","translate(0,128)").style("fill","none").style("stroke",z).call(S),I.x(q).scaleExtent([1,20]),d3.select("#whiteout"+n).on("click",function(){for(i in u)R(n,u[i],s,x);M=!M}),n!=K.K_max||o?r&&r==u.slice(-1)[0]&&(v=(f=d3.select("#modal_body_"+n).append("svg").attr("class","minorPopLabels_"+n).attr("height",C).attr("width",P)).append("g").attr("class","labelSVGminor_"+n).attr("transform","translate("+(k-2.5)+",0)"),0<Object.keys(_).length&&N(v,!0,n,tickVals),U(n)):(v=(f=d3.select("#visualization").append("svg").attr("class","majorPopLabels").attr("width",80+P)).append("g").attr("class","labelSVG").attr("transform","translate("+(k-2.5)+",0)"),0<Object.keys(_).length&&N(v,!1,n,tickVals),f.attr("height",v.node().getBBox().height+80)),X(t,n,d,o,K.K_min,"print"),o||(y=d.major_mode_runid),o&&(y=t[0][0].getAttribute("id").slice(4)),$("#"+y+"_print").click(function(t){t.preventDefault(),tt(0,o,0,y,"print")}),$("#"+y+"_download_png").click(function(t){t.preventDefault(),tt(0,o,0,y,"png")}),$("#"+y+"_download_svg").click(function(t){t.preventDefault(),tt(0,o,0,y,"svg")}),$(document).ready(function(){$('[data-toggle="tooltip"]').tooltip()}),0===--G&&$("#loading").delay(200).fadeOut()};var N=function(t,e,a,n){t.selectAll(".popLabels").data(n).enter().append("text").style("font-family","Helvetica").text(function(t,e){return _[e]}).attr("transform",function(t){return"translate("+(q(t)+5)+",10)rotate(45)"}).attr("class","popLabels noSelect").attr("id",function(t,e){return"major_pop"+e}).on("click",function(t,e){var a;d3.event.shiftKey&&o?1==(a=d3.selectAll("path.area.population"+e)).attr("fill-opacity")?a.attr("fill-opacity",.2):a.attr("fill-opacity",1):(d3.selectAll("path.area").attr("fill-opacity",function(t){K.qmatrices[t.K-K.K_min].color_perm;return!o&&t.population_index!=e?.2:1}),o=!o)})},E=function(t,e){var a=d3.select("body").append("div").attr("class","buttonDiv"),n=a.append("button").attr("class","modes btn btn-info btn-lg").attr("data-toggle","modal").attr("data-target","#modal-"+t).attr("id","button-"+t);n.style("position","absolute").style("top",129+180*(t-K.K_min)+98+"px").style("left",k+.84*P+20+"px"),n.html('<i class="fa fa-plus"></i> <span style="font-weight:bold; font-size:125%;">'+e.length+"</span>"),g(t,e,n,a)},g=function(e,a,t,n){var o=n.append("div").attr("class","modal fade").attr("id","modal-"+e).attr("role","dialog").append("div").attr("class","modal-dialog").append("div").attr("class","modal-content").attr("id","modal-content-"+e).style("width",45+P+"px").style("left",A+10+"px"),r=o.append("div").attr("class","modal-header").attr("id","title"+e);r.append("button").attr("type","button").attr("class","close").attr("data-dismiss","modal").html("<span>&times;</span>"),r.append("h2").attr("class","modal-title").html("Clustering modes, K="+e);m=new Array;var l=K.qmatrices[e-K.K_min].color_perm;$("#modal-"+e).on("hide.bs.modal",function(t){if(M){for(i in a)R(e,a[i],l,x);M=!1,$("#whiteout"+e).attr("checked",!1)}});var s,d=o.append("div").attr("class","modal-header").attr("id","modal_header2_"+e);for(dirtyGray=0,i=0;i<a.length;i++){var p=a[i];if(minor_obj=K.qmatrices[e-K.K_min].modes[p],0!=minor_obj.gray_indices.length){dirtyGray=1;break}}dirtyGray?((s=d.append("label").attr("class","checkbox-inline")).append("input").attr("type","checkbox").attr("class","check-input").attr("id","whiteout"+e),s.style("position","relative").style("top","4px"),d.append("label").attr("class","checkbox-caption noSelect").attr("for","whiteout"+e).text("\nCheck to highlight multimodality: ")):(mymodestr=1==a.length?"minor mode":"minor modes",d.append("button").attr("type","submit").attr("class","btn btn-danger btn-small pull-right").attr("id","highlightMM_"+e).attr("data-toggle","tooltip").attr("data-placement","left").attr("title","Similarity between corresponding clusters in the major mode and "+mymodestr+" is less than the similarity threshold of "+K.sim_threshold+". Lower the similarity threshold in pong's command line to enable highlighting.").text("Why can't I highlight multimodality?"));var c=K.qmatrices[e-K.K_min].major_mode_runid;plot=d3.select("#modal_header2_"+e).append("svg").attr("width",P).attr("height",175).attr("class","minorSVG-"+e+" first").attr("id","plot"+c+"_minor"),m.push(plot),u(c,"yes",c,"yes");o.append("div").attr("class","modal-body").attr("id","modal_body_"+e);for(i=0;i<a.length;i++){p=a[i];plot=d3.select("#modal_body_"+e).append("svg").attr("width",P).attr("height",175).attr("class","minorSVG-"+e).attr("id","plot"+p+"_minor"),m.push(plot),u(p,"yes",p,"no")}},H=function(t,e,a){var n=a.total_runs,i=a.major_mode_runid,o=a.modes[i].runs_represented.length;label=t.append("text").text("K = "+e),label.attr("class","label").style("font","bold 20px Helvetica, sans-serif"),label.attr("x",0).attr("y",74),runs=t.append("text").text(o+"/"+n+" runs").attr("id","major_repstring"),runs.attr("x",0).attr("y",99),runs.style("font","12px Helvetica, sans-serif");var r=new Array(a.modes[i].runs_represented.sort().join("-"),"runs");runs.data(r),runs.style("fill","#5bc0de").style("text-decoration","underline");var l=document.getElementById("major_repstring").getBBox().width;k<l&&(k=l+5),avg_sim=a.modes[i].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg. pairwise similarity: "+avg_sim.toString().substring(0,5)),sim.attr("x",k).attr("y",9),sim.style("fill","rgb(70, 184, 218)"),sim.style("font","bold 11px Helvetica, sans-serif"))},T=function(t,e,a,n){var i=e.total_runs,o=e.modes[a].runs_represented.length;"yes"==n&&(major=t.append("text").text("major mode"),major.attr("class","majorMinorLabel").attr("id","minor_bigstring"),major.attr("x",0).attr("y",64.4-38-15),major.style("font","bold 14px Helvetica, sans-serif")),k<83.609&&(k=88.609),label=t.append("text").text(a),label.attr("class","label"),label.attr("x",0).attr("y",64.4-26),label.style("font","20px Helvetica, sans-serif"),rep=t.append("text").text("represents"),rep.attr("x",0).attr("y",78.4-26),rep.style("font","12px Helvetica, sans-serif"),runs=t.append("text").text(o+"/"+i+" runs"),runs.attr("id","minor_repstring"),runs.attr("x",0).attr("y",68.4),runs.style("font","12px Helvetica, sans-serif");var r=new Array(e.modes[a].runs_represented.sort().join("-"),"runs");return runs.data(r),runs.style("fill","#5bc0de").style("text-decoration","underline"),avg_sim=e.modes[a].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg pairwise similarity:"+avg_sim.toString().substring(0,5)),sim.attr("class","avg_sim"),sim.attr("x",k).attr("y",10),sim.style("fill","rgb(70, 184, 218)"),sim.style("font","bold 12px Helvetica, sans-serif")),0},F=function(t,e){var a={};for(var n in e){var i=e[n],o=t.modes[i].runs_represented.length;a[i]=o}var r=Object.keys(a).map(function(t){return[t,a[t]]});r.sort(function(t,e){return e[1]-t[1]});var l=new Array;for(var n in r)l.push(r[n][0]);return l},R=function(t,e,a,n){var o=K.qmatrices[t-K.K_min].modes[e];if(null!=o.gray_indices){var r=o.gray_indices;for(i in o.gray_indices){var l="."+e+"_minorCluster"+a[r[i]],s=d3.select("#modal_body_"+t).select(".printModal"),d=d3.select("#modal_body_"+t).select(".modalDropdown a div");"rgb(255, 255, 255)"!=d3.selectAll(l).style("fill")?(d3.selectAll(l).style("fill","white"),s.classed("btn btn-primary",!0).text("Print highlighting multimodality at K="+t),d.classed("btn btn-primary",!0).text("Download highlighting multimodality at K="+t)):(d3.selectAll(l).style("fill",B[a[r[i]]]),s.classed("btn-primary",!1).text("Print all modes at K="+t),d.classed("btn-primary",!1).text("Download all modes at K="+t))}}},W=function(t,e){var a=K.qmatrices[e-K.K_min].avg_sim_bt_modes,n=Math.round(1e3*a)/1e3;null!=n&&(simMode=d3.select("#title"+e).append("h4").text("\nAvg pairwise similarity among modes = "+n))},Y=d3.tip().direction("s").attr("class","d3-tip").offset([10,0]).attr("font-size","14px").html(function(t){for(var e=t.split("-"),a='<div class="text-center text-tip"><strong>runs<br>represented</strong>',n=0,i=e.length;n<i;n++)a+="<br>"+e[n];return a}),J=d3.tip().direction("s").attr("class","d3-tip").offset([10,0]).html(function(t){var e=t.K,a=K.qmatrices[e-K.K_min].color_perm,i='<div class="text-center text-tip"><strong>'+_[t.population_index]+"</strong><br>"+s[t.population_index]+" samples</div><br>";i+="<div><ul>";for(var n=[],o=0;o<e;o++)n.push({datum:t.indiv_avg[o],color:B[a[o]]});return n.sort(function(t,e){return t.datum>e.datum?-1:t.datum==e.datum?0:1}),n.forEach(function(t,e){var a=Math.round(1e3*t.datum)/10,n=t.color;.5<=a&&(i+='<i class="fa fa-circle" style="color: '+n+' "></i>',i+="&nbsp;<strong> "+a+"%</strong></li><br>")}),i+="</ul></div>"}),n=new Tour({storage:!1});n.addSteps([{placement:"top",backdrop:!0,orphan:!0,title:"Welcome to pong!",content:"This tour will walk you through pong's main features."},{element:".background:first",placement:"bottom",title:"The major mode plot",content:function(){return"This plot shows a representative run of the major mode for K = "+K.K_min+". You can zoom in and out of the plots by placing your cursor above the plot and performing a mouse scroll. Clicking on a color within  a plot will highlight that color across K values in all plots (including minor modes)."}},{element:"#major_repstring:first",placement:"right",title:"Runs represented",content:function(){return"Hovering here shows you which runs are represented by the major mode plot for K = "+K.K_min+", sorted by runID."}},{element:".majorPopLabels",placement:"top",title:"Population labels",content:function(){return"Clicking on a population label will highlight that population across K values. Shift-clicking allows you to select multiple populations."}},{element:".pbDiv:last",placement:"right",title:"Print and download",content:"These icons let you print a plot or download it locally as a PNG or SVG."},{element:".print-download",placement:"top",title:"Print and download everything",content:"Alternatively, use these buttons to print/download all currently displayed plots in one file."},{element:"button.modes:last",placement:"left",title:"Minor modes",content:"If there is multimodality for a given K value, you can click on this button to see representative runs for the minor mode(s)."},{orphan:!0,placement:"top",backdrop:!0,title:"That's the bulk of it!",content:"Consult the documentation to find out more about pong's features. Feel free to reach out to us directly if you have any questions or feedback. We hope you enjoy using pong!"}]),n.init(),$("#help").on("click",function(){n.restart()}),$(document).on("click","#printAllPlots",function(){v("no","print")}),$(document).on("click",".printModal",function(){v($(this)[0].id,"print")}),$(document).on("click","#main_png",function(){v("no","png")}),$(document).on("click","#main_svg",function(){v("no","svg")}),$(document).on("click",".downloadModalPNG",function(){v($(this)[0].id,"png")}),$(document).on("click",".downloadModalSVG",function(){v($(this)[0].id,"svg")});var U=function(t){var e=d3.select("#modal_body_"+t).append("div").attr("class","modal-body").append("div").attr("class","row").append("div").attr("class","text-center"),a=(e.append("button").attr("type","submit").attr("class","btn btn-default printModal").attr("id",t).text("Print all modes at K="+t),e.append("div").attr("class","dropdown dropdown-toggle modalDropdown")),n=a.append("a").attr("class","dropdown").attr("data-toggle","dropdown").attr("aria-expanded","false").append("div").attr("class","btn btn-default").text("Download all modes at K="+t);f(a,t,n,!0)},f=function(t,e,a,n){var i=t.append("ul").attr("class","dropdown-menu download-menu").attr("id",e+"_dropdown"),o=i.append("div").attr("class","slider").style("margin","10px").style("margin-left","15px").style("margin-right","15px").style("font-size","12px").attr("id","slider_div_"+e);o.append("div").attr("class","img_slider").text("Image size"),o.append("div").attr("id","slider_"+e),o.on("click",function(){d3.event.stopPropagation(),d3.event.preventDefault()});var r=o.append("div").attr("class","slider_axis").style("display","flex").style("justify-content","space-between").style("width","100%").style("font-size","9px");r.append("div").text("Smaller"),r.append("div").text("Larger");var l=i.append("li").append("a").attr("data-format","png").attr("title","Download plot as PNG").text("PNG"),s=i.append("li").append("a").attr("data-format","svg").attr("title","Download plot as SVG").text("SVG");n?(l.attr("class","downloadModalPNG").attr("id",e),s.attr("class","downloadModalSVG").attr("id",e)):(l.attr("id",e+"_png"),s.attr("id",e+"_svg")),Modernizr.adownload||(a.attr("data-toggle","tooltip").attr("data-placement","top").attr("title","Download not fully supported in this browser. Please save the following page after selecting a file type to download locally."),s.append("tspan").text(" (Save with format 'Page Source')").style("font-size","10px")),$("#slider_"+e).slider({value:2,min:1,max:3,step:.5})},X=function(t,e,a,n,i,o){var r,l,s,d,p,c;n||(r=d3.select("body").append("div").attr("class","pbDiv").style("top",180*(e-i+1)+110+"px"),l=a.major_mode_runid+"_print",s=a.major_mode_runid+"_download"),n&&(r=d3.select("#modal_body_"+e).append("div").attr("class","pbDiv"),l=t[0][0].getAttribute("id").slice(4)+"_print",s=t[0][0].getAttribute("id").slice(4)+"_download",d=t[0][0].getAttribute("id").slice(4).slice(0,t[0][0].getAttribute("id").slice(4).indexOf("_minor")),p=Object.keys(a.modes),0==(c=F(a,p).indexOf(d))?r.style("top","-80px"):r.style("top",180*(c-1)+130+"px"));r.style("position","absolute").style("display","inline-flex").style("left","32px");var m=r.append("a").attr("id",l).style("margin","4px").append("span").attr("class","glyphicon glyphicon-print");n?(m.attr("title","Print "+d+" barplot"),m.attr("id","print-minor-"+d)):(m.attr("title","Print K="+e+" barplot"),m.attr("id","print-major-"+e));m=(r=r.append("div").attr("class","dropdown").style("margin","4px")).append("a").attr("id",s).attr("data-toggle","dropdown").attr("class","dropdown-toggle").attr("aria-expanded","false").attr("aria-hadpopup","true").append("span").attr("class","glyphicon glyphicon-download-alt");f(r,s,m,!1),n?m.attr("id","download-minor-"+d):m.attr("id","download-major-"+e)},y=2;function b(t,e,a){var n=$("#slider_main");return e&&"no"!=t?n=$("#slider_"+t):"no"!=t&&(n=$("#slider_"+t+"_download")),"png"==a&&e?.5*n.slider("option","value"):n.slider("option","value")}function Q(t,e){var a=document.createElement("a");a.href=t.src,a.type="hidden",a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a)}function Z(t,e){var a=document.createElement("a");a.href=t.toDataURL("image/png"),a.type="hidden",a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a)}function tt(t,a,e,n,i){y=b(n,!1,i);var o,r,l=d3.select("#plot"+n).node(),s=d3.select(".majorPopLabels").node(),d=[s.getBoundingClientRect().width+5,s.getBoundingClientRect().height+5],p=new Date,c=p.getFullYear()+"-"+p.getMonth()+"-"+p.getDate()+"_"+p.getHours()+"h"+p.getMinutes()+"m"+p.getSeconds()+"s",m="K="+d3.select("#plot"+n).attr("class").split(" ")[1]+"_majormode_"+c+"_pong";a&&(o=l.getAttribute("class").split(" "),r=o[0].slice(l.getAttribute("class").indexOf("-")+1),m=o.length<2?n.substr(0,n.indexOf("_"))+"_K="+r+"_minormode_"+c+"_pong":n.substr(0,n.indexOf("_"))+"_K="+r+"_majormode_"+c+"_pong",s=d3.select(".minorPopLabels_"+r).node(),d3.select(".minorPopLabels_"+r).attr("height",d[1]).attr("width",d[0]));var u,h,g,f=l.getBoundingClientRect(),v=document.createElement("canvas");v.width=Math.max(d[0],f.width/I.scale())*y+20,v.height=(d[1]+f.height)*y+20,"print"==i&&((u=window.open()).document.title="pong download"),"svg"==i?((h=document.createElementNS("http://www.w3.org/2000/svg","svg")).setAttribute("width",Math.max(d[0],f.width/I.scale())),h.setAttribute("height",d[1]+f.height),h.appendChild(l.cloneNode(!0)),(g=s.cloneNode(!0)).setAttribute("y",f.height),h.appendChild(g),et(h,null,0,function(t){Q(t,m+".svg"),a&&d3.select(".minorPopLabels_"+r).attr("height",C).attr("width",P)})):et(l,v,0,function(e){et(s,v,f.height*y,function(t){"print"==i?(u.document.body.appendChild(e),u.document.body.appendChild(t),u.print()):Z(v,m+".png"),a&&d3.select(".minorPopLabels_"+r).attr("height",C).attr("width",P)})})}function v(e,a){y=b(e,!0,a);var n=d3.select(".majorPopLabels").node(),t=[n.getBoundingClientRect().width+5,n.getBoundingClientRect().height+5],i=new Date,o=i.getFullYear()+"-"+i.getMonth()+"-"+i.getDate()+"_"+i.getHours()+"h"+i.getMinutes()+"m"+i.getSeconds()+"s",r="mainviz_"+o+"_pong",l=document.getElementsByClassName("majorSVG");"no"!=e&&(l=document.getElementsByClassName("minorSVG-"+e),r="modes_K="+e+"_"+o+"_pong",n=d3.select(".minorPopLabels_"+e).node(),d3.select(".minorPopLabels_"+e).attr("height",t[1]).attr("width",t[0]));var s,d=d3.select(l[0]).node().getBBox(),p=document.createElement("canvas");p.width=Math.max(t[0],d.width/I.scale())*y,p.height=(t[1]+(d.height+20)*l.length)*y,"print"==a&&((s=window.open()).document.title="pong download");var c=0,m=document.createElementNS("http://www.w3.org/2000/svg","svg");m.setAttribute("width",Math.max(t[0],d.width/I.scale())),m.setAttribute("height",t[1]+(d.height+20)*l.length);for(var u=0;u<l.length;u++){var h,g,f=d3.select(l[u]);"svg"==a?((h=d3.select(l[u]).node().cloneNode(!0)).setAttribute("y",(d.height+20)*u),m.appendChild(h),(c+=1)==l.length&&((g=n.cloneNode(!0)).setAttribute("y",(d.height+20)*l.length),m.appendChild(g),et(m,null,0,function(t){Q(t,r+".svg"),"no"!=e&&d3.select(".minorPopLabels_"+e).attr("height",C).attr("width",P)}))):et(f.node(),p,(d.height+20)*u*y,function(t){"print"==a&&s.document.body.appendChild(t),(c+=1)==l.length&&et(n,p,(d.height+20)*l.length*y,function(t){"print"==a?(s.document.body.appendChild(t),s.print()):"png"==a&&Z(p,r+".png"),"no"!=e&&d3.select(".minorPopLabels_"+e).attr("height",C).attr("width",P)})})}}function et(t,e,a,n){var i,o=(new XMLSerializer).serializeToString(t),r=new Image;r.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(o))),e?(i=e.getContext("2d"),r.onload=function(){i.drawImage(r,0,0,r.width,r.height,0,a,r.width*y,r.height*y),n&&(n(r),r.onload=null)}):n(r)}function at(t,e){var a=/[^0-9]/g,n=parseInt(t.replace(a,""),10),i=parseInt(e.replace(a,""),10);return n===i?0:i<n?1:-1}f(d3.select("#downloadAllDiv"),"main",d3.select("#downloadAllDropdownLink"),!1)});