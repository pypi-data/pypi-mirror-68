---
- name: already formatted volume will not be clobbered
  hosts: infrastructure3-host
  become: true

  pre_tasks:

    - name: mkfs.ext4 /dev/mapper/spare
      filesystem:
        fstype: ext4
        dev: /dev/sdb

    - include_role:
        name: encrypted_device
      vars:
        encrypted_device_mount_point: /opt

    - debug:
        msg: "{{ encrypt_format }}"

    - assert:
        that: "'Ignored' in encrypt_format.stdout"

- name: verify encrypted volumes
  hosts: infrastructure1-host,infrastructure2-host
  become: true

  pre_tasks:
    - name: create an encryption key to be re-used
      file:
        state: directory
        path: "{{ enough_domain_config_directory }}/volume-keys"
      delegate_to: localhost
      become: no

    # verified by infrastructure/tests/test_encrypted_reuse_key_volume.py
    - name: create an encryption key to be re-used
      copy:
        content: "PASSWORD"
        dest: "{{ enough_domain_config_directory }}/volume-keys/infrastructure2-volume.key"
      delegate_to: localhost
      become: no

  roles:
    - role: encrypted_device
      encrypted_device_mount_point: /opt
